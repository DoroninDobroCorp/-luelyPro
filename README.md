# CluelyPro - Голосовой Ассистент для Экзаменов

Интеллектуальный голосовой ассистент с AI для помощи на устных экзаменах. Распознает речь экзаменатора, генерирует тезисы-подсказки и отслеживает их раскрытие в ответах студента.

## Архитектура

Проект построен на модульной архитектуре с четким разделением ответственности:

```
main.py → live_recognizer.py ─┬─→ asr_transcriber.py (Whisper)
                               ├─→ thesis_prompter.py ─┬─→ thesis_judge.py (Gemini)
                               │                        ├─→ semantic_matcher.py
                               │                        └─→ thesis_generator.py (Gemini)
                               ├─→ llm_answer.py (Gemini)
                               ├─→ tts_silero.py
                               ├─→ vad_silero.py
                               └─→ config.py
```

## Основные Файлы

### main.py
Точка входа в приложение с CLI интерфейсом.

**Основные функции:**
- `build_parser()` - создание парсера аргументов командной строки
- `main()` - главная функция запуска приложения

**Команды:**
- `enroll` - запись голосового профиля пользователя
- `live` - запуск live-распознавания с ассистентом
- `profiles list/delete` - управление голосовыми профилями
- По умолчанию - интерактивный режим с выбором/созданием профиля

### live_recognizer.py
Ядро системы: распознавание голоса, диаризация (свой/чужой), ASR, LLM, тезисы.

**Основные классы:**
- `VoiceProfile` - голосовой профиль пользователя (эмбеддинги)
- `LiveVoiceVerifier` - распознавание своего/чужого голоса в реальном времени
- `QueuedSegment` - сегмент речи для обработки

**Основные функции:**
- `enroll_cli()` - запись голосового профиля
- `live_cli()` - запуск live-режима с ассистентом
- `extract_theses_from_text()` - извлечение тезисов из текста (для тестов)
- `setup_logging()` - настройка логирования

**Workflow:**
1. Захват аудио с микрофона через sounddevice
2. VAD детектирует речевые сегменты
3. Эмбеддинг → определение свой/чужой голос
4. Чужой → ASR → генерация тезисов → озвучка через TTS
5. Свой → ASR → проверка раскрытия тезисов → LLM ответ (опционально)

### config.py
Централизованная конфигурация всех модулей.

**Классы конфигурации:**
- `VADConfig` - настройки Voice Activity Detection
- `ASRConfig` - настройки распознавания речи (Whisper)
- `ThesisConfig` - настройки тезисного помощника
- `AudioConfig` - настройки аудио потока
- `LLMConfig` - настройки языковой модели (Gemini)
- `VerifierConfig` - настройки верификатора голоса (ECAPA)
- `SystemConfig` - системные настройки
- `AppConfig` - главный конфиг (объединяет все)

**Функции:**
- `AppConfig.default()` - дефолтная конфигурация
- `AppConfig.from_env()` - конфигурация из переменных окружения

### thesis_prompter.py
Управление списком тезисов с отслеживанием произнесённых пунктов.

**Класс:**
- `ThesisPrompter` - менеджер тезисов

**Основные функции:**
- `has_pending()` - есть ли непроизнесенные тезисы
- `need_announce()` - нужно ли озвучить текущий тезис
- `current_text()` - текст текущего тезиса
- `mark_announced()` - пометить тезис как озвученный
- `consume_transcript()` - обработать реплику диалога (студент/экзаменатор)
- `remaining_count()` - количество оставшихся тезисов
- `coverage_of_current()` - процент покрытия текущего тезиса

**Методы оценки:**
1. Токенное сравнение (быстрое, базовое)
2. Семантическое сравнение через эмбеддинги (фоллбэк)
3. Gemini-судья (основной метод, AI-оценка)

### thesis_judge.py
AI-судья для оценки раскрытия тезиса через Google Gemini.

**Класс:**
- `GeminiJudge` - судья на основе Gemini

**Основные функции:**
- `judge(thesis, dialogue_context)` - оценка покрытия тезиса
  - Вход: тезис + контекст диалога (список реплик студент/экзаменатор)
  - Выход: (покрыт: bool, уверенность: 0..1)
- `set_upgrade_callback()` - установка callback для обновлений от Pro модели
- `get_metrics()` - статистика работы (успехи/провалы/время)

**Архитектура:**
- Flash Lite (быстрый ответ)
- Pro модель (параллельно, улучшает оценку)
- OpenAI fallback (если Gemini недоступен)

### thesis_generator.py
Генерация тезисов-подсказок из вопроса экзаменатора.

**Класс:**
- `GeminiThesisGenerator` - генератор тезисов через Gemini

**Основные функции:**
- `generate(question_text, n=8, language='ru')` - генерация N тезисов
  - Вход: текст вопроса
  - Выход: список коротких фактов (5-10 слов каждый)

**Особенности:**
- Генерирует только конкретные неочевидные факты
- Возвращает пустой массив если тема неизвестна
- Фильтрует объяснения типа "не знаю", "нет информации"

### semantic_matcher.py
Семантическое сравнение текстов через трансформерные эмбеддинги.

**Класс:**
- `SemanticMatcher` - сравнение текстов

**Основные функции:**
- `encode(text)` - получение эмбеддинга текста
- `score(text_a, text_b)` - семантическая близость (0..1)

**Используемая модель:**
- `intfloat/multilingual-e5-small` (многоязычная)

### llm_answer.py
Генерация ответов на вопросы через Google Gemini.

**Класс:**
- `LLMResponder` - генератор ответов

**Основные функции:**
- `generate(user_text)` - генерация ответа на вопрос
  - Классификация запроса (short/normal/extended)
  - Генерация с потоковой передачей
  - Постобработка (числа прописью, удаление латиницы)

**Особенности:**
- Только факты, без мнений и советов
- Все числа и годы прописью (1945 → тысяча девятьсот сорок пятый)
- Краткие ответы (1-3 предложения)
- Поддержка истории диалога (до 8 пар вопрос-ответ)

### asr_transcriber.py
Распознавание речи через faster-whisper (оптимизированный Whisper).

**Класс:**
- `FasterWhisperTranscriber` - транскрибер речи

**Основные функции:**
- `transcribe_np(wav, sample_rate=16000)` - транскрибация аудио
  - Вход: numpy массив (float32, моно, 16kHz)
  - Выход: текст распознанной речи

**Особенности:**
- Автоматический фоллбэк CPU при ошибке CUDA
- Фильтрация галлюцинаций (кредиты, повторы)
- Поддержка initial_prompt для снижения галлюцинаций
- Дедупликация повторяющихся слов

**Модели:**
- tiny/base/small - для быстрой работы
- medium/large-v3/large-v3-turbo - для точности

### tts_silero.py
Синтез речи через Silero TTS (русские голоса).

**Класс:**
- `SileroTTS` - синтезатор речи

**Основные функции:**
- `synth(text)` - синтез речи из текста
  - Вход: обычный текст или SSML
  - Выход: numpy массив (float32, моно, 24kHz)
- `save_wav(path, audio, sample_rate)` - сохранение в WAV

**Доступные голоса (ru):**
- eugene (мужской, по умолчанию)
- kseniya, baya, xenia, aidar

### vad_silero.py
Детектор активности речи через Silero VAD.

**Класс:**
- `SileroVAD` - детектор речи

**Основные функции:**
- `is_speech(frame)` - проверка наличия речи во фрейме
  - Вход: короткий аудио фрейм (float32, 16kHz)
  - Выход: True если речь обнаружена
- `reset()` - сброс внутреннего состояния

**Особенности:**
- Скользящее окно (100мс по умолчанию)
- Порог вероятности (0.5 по умолчанию)
- Работает только на CPU для стабильности

### exceptions.py
Кастомные исключения для всех модулей.

**Иерархия:**
- `CluelyProException` - базовое исключение
  - `AudioDeviceError` - ошибки микрофона
  - `ASRError` - ошибки распознавания речи
  - `LLMError` - ошибки LLM
  - `ThesisGenerationError` - ошибки генерации тезисов
  - `ThesisJudgeError` - ошибки судьи тезисов
  - `TTSError` - ошибки синтеза речи
  - `VADError` - ошибки VAD
  - `EmbeddingError` - ошибки эмбеддингов
  - `ProfileError` - ошибки профилей
  - `ConfigError` - ошибки конфигурации

## Установка

```bash
# Установка зависимостей
pip install -r requirements.txt

# Или через uv (быстрее)
uv sync

# Настройка переменных окружения
cp .env.example .env
# Отредактируйте .env, добавьте GEMINI_API_KEY
```

## Использование

### Быстрый старт
```bash
# Запуск с интерактивным выбором профиля
python main.py

# Первый запуск предложит создать голосовой профиль
# Прочитайте текст в микрофон в течение 20 секунд
```

### Команды CLI

**Создание голосового профиля:**
```bash
python main.py enroll --profile my_profile.npz
```

**Live-режим:**
```bash
python main.py live --profile my_profile.npz --asr --llm
```

**Управление профилями:**
```bash
# Список профилей
python main.py profiles list

# Удаление профиля
python main.py profiles delete --name my_profile

# Удаление всех профилей
python main.py profiles delete --all
```

### Основные флаги

**VAD:**
- `--vad-backend webrtc|silero` - выбор VAD
- `--vad-aggr 0..3` - агрессивность WebRTC VAD
- `--silero-vad-th 0..1` - порог Silero VAD

**ASR:**
- `--asr` - включить распознавание речи
- `--asr-model tiny|base|small|medium|large-v3|large-v3-turbo` - размер модели Whisper
- `--asr-lang ru` - язык распознавания
- `--asr-device cuda|cpu` - устройство для ASR

**LLM:**
- `--llm` - включить генерацию ответов через Gemini

**Тезисы:**
- `--theses path/to/theses.txt` - файл с тезисами (опционально)
- `--no-theses` - отключить тезисный помощник
- `--thesis-match 0..1` - порог совпадения токенов (по умолчанию 0.6)
- `--thesis-semantic 0..1` - порог семантической близости (по умолчанию 0.55)
- `--thesis-gemini-conf 0..1` - мин. уверенность Gemini (по умолчанию 0.60)

**Система:**
- `--run-seconds N` - авто-остановка через N секунд (0 = бесконечно)

## Переменные Окружения

Создайте файл `.env` на основе `.env.example`:

```bash
# Обязательные
GEMINI_API_KEY=your_gemini_api_key_here

# Опциональные
ASR_MODEL=small                 # tiny|base|small|medium|large-v3|large-v3-turbo
ASR_LANG=ru                     # язык ASR
CONSOLE_LOG_LEVEL=INFO          # уровень логов в консоли
FILE_LOG_LEVEL=DEBUG            # уровень логов в файле
LOG_DIR=logs                    # папка для логов

# Режимы работы
AI_ONLY_THESIS=1                # только AI-генерация тезисов (без статических)
COMMENTARY_MODE=0               # режим комментариев (факты без явных вопросов)
QUESTION_FILTER_MODE=gemini     # heuristic|gemini
USE_HEADPHONES=1                # True = микрофон не слышит TTS

# Тезисы
THESIS_REPEAT_SEC=10            # интервал повтора текущего тезиса (секунды)
THESIS_AUTOGEN_BATCH=3          # размер пакета автогенерируемых тезисов

# Авто-остановка для тестов
RUN_SECONDS=0                   # 0 = бесконечно
ASSISTANT_RUN_SECONDS=0         # альтернативное имя
```

## Workflow Пример

1. **Запуск ассистента:**
   ```bash
   python main.py
   ```

2. **Экзаменатор задает вопрос:**
   - Система распознает чужой голос
   - ASR транскрибирует вопрос
   - Gemini генерирует 3-8 тезисов-подсказок
   - TTS озвучивает первый тезис

3. **Студент отвечает:**
   - Система распознает свой голос
   - ASR транскрибирует ответ
   - Gemini-судья оценивает раскрытие тезиса
   - При полном раскрытии → озвучка следующего тезиса

4. **Если нужна помощь:**
   - Студент может попросить LLM сгенерировать ответ
   - LLM генерирует краткий фактический ответ
   - TTS озвучивает ответ

## Технологии

- **ASR**: faster-whisper (оптимизированный Whisper от OpenAI)
- **LLM**: Google Gemini (Flash Lite + Pro)
- **TTS**: Silero TTS (русские голоса)
- **VAD**: Silero VAD / WebRTC VAD
- **Эмбеддинги голоса**: pyannote.audio (ECAPA-TDNN)
- **Семантика**: multilingual-e5-small (sentence-transformers)
- **Аудио**: sounddevice, numpy

## Требования

- Python 3.10+
- CUDA (опционально, для ускорения ASR)
- Микрофон
- Google Gemini API ключ

## Структура Проекта

```
CluelyPro/
├── main.py                    # CLI и точка входа
├── live_recognizer.py         # Ядро системы (диаризация, ASR, LLM, тезисы)
├── config.py                  # Централизованная конфигурация
├── exceptions.py              # Кастомные исключения
│
├── thesis_prompter.py         # Менеджер тезисов
├── thesis_judge.py            # AI-судья (Gemini)
├── thesis_generator.py        # Генератор тезисов (Gemini)
├── semantic_matcher.py        # Семантическое сравнение
│
├── llm_answer.py              # LLM ответы (Gemini)
├── asr_transcriber.py         # ASR (faster-whisper)
├── tts_silero.py              # TTS (Silero)
├── vad_silero.py              # VAD (Silero)
│
├── theses.txt                 # Файл с тезисами (опционально)
├── requirements.txt           # Python зависимости
├── pyproject.toml             # Конфигурация проекта (uv)
├── .env.example               # Пример переменных окружения
│
├── profiles/                  # Голосовые профили (.npz)
└── logs/                      # Логи работы системы
    └── assistant.log
```

## Лицензия

MIT License

## Автор

Vladimir Doronin
