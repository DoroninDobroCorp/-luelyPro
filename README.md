# diarization — лайв: «свой/чужой» + ASR + LLM + тезисы с озвучкой

Интерактивный модуль, который:
- Определяет «свой/чужой» по голосу.
- Транскрибирует чужую речь (ASR).
- Даёт короткие ответы (LLM) и озвучивает их.
- Ведёт тезисный помощник: генерирует 2–3 тезиса к вопросу, озвучивает, и проверяет, что вы раскрыли тезисы — по смыслу.

По умолчанию, если файл `theses.txt` пустой или отсутствует — включается автогенерация тезисов из вопросов собеседника через Gemini Flash Lite.

## Основные возможности

- «Свой/чужой» голос: ECAPA эмбеддинги (`speechbrain/spkrec-ecapa-voxceleb`).
- VAD: WebRTC (по умолчанию) или Silero; фильтрация шумов по спектральной плоскостности.
- ASR (чужая речь): `faster-whisper` с анти-галлюциногенным промптом и постфильтрами.
- LLM-ответ: короткая подсказка, озвучивается через Silero TTS.
- Тезисы:
  - Автогенерация пакетов тезисов (2–3) из чужой речи через Gemini Flash Lite.
  - Озвучивание пакета, пошаговая проверка покрытия.
  - Судья на Gemini оценивает «тезис покрыт» по смыслу и уверенности.
  - Фоллбэки: ключевые слова и семантика (эмбеддинги E5).

## Требования

- Python 3.12+
- macOS с микрофоном 16 kHz mono
- Менеджер пакетов: `uv` (рекомендуется)
- .env:
  - `GEMINI_API_KEY=<ваш ключ>` — для генерации/судьи тезисов (Google AI Studio)

## Установка

```bash
uv sync
```

Проверка CLI:
```bash
uv run python main.py --help
```

## Быстрый старт

### 0) Запуск «одним файлом» (без параметров)

Самый простой способ — просто запустить `main.py` без аргументов. Скрипт:

- предложит выбрать голосовой профиль из `profiles/` или создать новый;
- если профиля нет — запишет новый (около 6 секунд);
- запустит лайв-ассистента: чужая речь → ASR → короткий ответ (LLM, озвучка) → пакет тезисов; проверяет покрытие тезисов и подсовывает новые.

Примеры:

```bash
# Запуск с дефолтами
python main.py

# Дымовой тест (10 сек) + лёгкая ASR-модель
ASSISTANT_RUN_SECONDS=10 ASR_MODEL=tiny python main.py
```

Полезные переменные окружения:

- `ASSISTANT_RUN_SECONDS` (или `RUN_SECONDS`) — авто-остановка через N секунд (по умолчанию 0 — бесконечно)
- `ASR_MODEL` — размер модели ASR (`tiny|base|small|medium|large-v3|large-v3-turbo`), по умолчанию `small`

### 1) Запись голосового профиля (для «свой/чужой»)
```bash
uv run python main.py enroll \
  --seconds 8 --min-voiced-seconds 4 \
  --vad-aggr 3 \
  --min-consec 7 \
  --flatness-th 0.55
```
Профиль сохранится в `voice_profile.npz`. Используйте эти значения как пример строгих настроек к шумам.

Опционально можно читать готовый текст при записи профиля:
```bash
uv run python main.py enroll \
  --profile profiles/my_voice.npz \
  --seconds 12 --min-voiced-seconds 6 \
  --read-script-file enrollment_text.txt
```

### 2) Live-режим (ИИ-только: выдаём только тезисы, если во входе есть вопросы)
```bash
uv run python main.py live \
  --select-profile --auto-enroll-if-missing \
  --asr --asr-lang ru \
  --llm
```

AI-only поведение:

- Вся чужая речь идёт в ИИ-фильтр. Если есть содержательные вопросы к кандидату — модель вернёт тезисы.
- Если вопросов нет — ассистент молчит (не отвечает «от себя»).
- Текущий тезис периодически повторяется, пока не будет закрыт вашей речью.

Переменные окружения для AI-only:

- `AI_ONLY_THESIS=1` — включить режим «только тезисы от ИИ, если есть вопросы» (по умолчанию включено)
- `QUESTION_FILTER_MODE=gemini` — фильтровать вопросы только ИИ (по умолчанию)
- `THESIS_REPEAT_SEC=15` — переозвучивать текущий тезис каждые N секунд, если он не закрыт

Gemini обязателен для AI-only режима: `GEMINI_API_KEY` должен быть задан.

Быстрый дымовой тест (без интерактива), с профилем `profiles/smoke.npz` и лёгкой моделью ASR:

```bash
ASSISTANT_RUN_SECONDS=10 ASR_MODEL=tiny python main.py live \
  --profile profiles/smoke.npz \
  --auto-enroll-if-missing \
  --asr --llm \
  --run-seconds 10
```

Что произойдёт:
- Система предложит выбрать профиль из `profiles/` или записать новый.
- Чужая речь → ASR → генерируется пакет 2–3 тезисов (Gemini) → озвучивается.
- Вы отвечаете; система проверяет, что тезисы раскрыты (ключевые слова → семантика → судья Gemini).
- Когда пакет исчерпан — генерируется следующий.

Для короткого смоук-теста на 10 секунд:
```bash
uv run python main.py live --asr --llm --run-seconds 10
```

## Гибридный Веб-режим (Remote Mic/Ear)

В этом режиме браузер выступает «удалённым микрофоном и наушником», а весь ML‑поток выполняется в Python.

- Браузер: захватывает микрофон → отправляет сырой PCM16 mono 16 kHz по WebSocket → принимает готовый аудиоответ (WAV) и проигрывает.
- Python: VAD → «свой/чужой» (ECAPA) → ASR (faster‑whisper) незнакомой речи → генерация тезисов (Gemini) → TTS (Silero) → отправка в браузер.

### Запуск

```bash
# 1) Поднять сервер (WebSocket + статический HTTP). Авто‑стоп: 10с, чтобы не зависнуть
./run.sh web

# Переменные окружения (опционально)
HOST=127.0.0.1 WS_PORT=8765 HTTP_PORT=8000 RUN_SECONDS=10 ./run.sh web
```

Откройте в браузере:

```
http://127.0.0.1:8000/index.html
```

Нажмите «Connect». Браузер запросит доступ к микрофону, начнётся поток на Python. Озвученные тезисы будут воспроизводиться автоматически.

### Зависимости и ключи

- Требуется `websockets` (добавлено в `requirements.txt`).
- Для автогенерации тезисов/LLM‑фильтров задайте `GEMINI_API_KEY`.

### Тюнинг (ENV)

- `ASR_MODEL` — `tiny|base|small|...` (по умолчанию `tiny` в веб‑режиме).
- `VAD_BACKEND` — `webrtc|silero` (по умолчанию `webrtc`).
- `MIN_SEGMENT_MS` (по умолчанию `400`), `MAX_SILENCE_MS` (`300`), `PRE_ROLL_MS` (`100`).
- `PROFILE=profiles/my_profile.npz` — путь к профилю. Если не найден, все голоса считаются «чужими».
- Таймеры авто‑остановки: `RUN_SECONDS`/`ASSISTANT_RUN_SECONDS`.

### Отличия от `live`

- Источник аудио — веб‑браузер (WebSocket), а не `sounddevice`.
- TTS не проигрывается локально; вместо этого отправляется в браузер в формате WAV.

### Смоук‑тест

```bash
RUN_SECONDS=10 ASR_MODEL=tiny ./run.sh web
# Открыть http://127.0.0.1:8000/ и нажать Connect. Наблюдать логи в консоли сервера.
```

### Управление профилями

```bash
python main.py profiles list
python main.py profiles delete --name my_voice
python main.py profiles delete --all
```

## Тезисный помощник

- Если `theses.txt` (в `diarization/`) отсутствует или пуст — включается автогенерация из чужой речи.
- Если `theses.txt` заполнен построчно — используется статический список (по одному тезису в строке, маркеры `-`, `*`, цифры — игнорируются).
- Проверка «тезис покрыт»:
  1) Ключевые слова
  2) Семантическая близость (эмбеддинги E5)
  3) Судья на Gemini (Flash Lite), возвращает covered/confidence

## Полезные флаги (команда live)

Базовые:
- `--profile PATH` — путь к профилю (по умолчанию `voice_profile.npz`)
- `--select-profile` — интерактивный выбор/создание профиля в каталоге
- `--profiles-dir PATH` — каталог профилей (по умолчанию `profiles/`)
- `--auto-enroll-if-missing` — если нет файла профиля, записать новый (6 сек)
- `--threshold 0.30..0.90` — порог косинусной дистанции (≤ — свой голос)
- `--run-seconds N` — автостоп через N секунд (0 — бесконечно)

Шумоподавление/VAD:
- `--vad-aggr 0..3` — агрессивность WebRTC VAD (выше — строже)
- `--min-consec N` — минимум подряд речевых кадров по 20 мс
- `--flatness-th 0..1` — порог спектральной плоскостности (меньше — строже)
- `--vad-backend webrtc|silero`
- `--silero-vad-th 0..1` и `--silero-vad-window MS`

ASR:
- `--asr` — включить распознавание чужой речи
- `--asr-model` — `tiny|base|small|medium|large-v3|large-v3-turbo` (и др.)
- `--asr-lang ru|...`
- `--asr-device cuda|cpu`
- `--asr-compute float16|int8|...`

LLM:
- `--llm` — включить короткие ответы (озвучиваются)

Тезисы:
- `--theses PATH` — путь к статическому файлу тезисов (по одному в строке)
- `--no-theses` — полностью отключить помощника
- Семантика (фоллбэк):
  - `--thesis-semantic 0..1` — порог семантики (по умолчанию 0.55)
  - `--thesis-semantic-model` — ID модели эмбеддингов (E5)
  - `--thesis-semantic-disable` — отключить семантику (оставить токены/Gemini)
- Судья Gemini:
  - `--thesis-gemini-conf 0..1` — минимальная уверенность для закрытия тезиса (по умолчанию 0.60)
  - `--thesis-gemini-disable` — отключить судью (останутся токены/семантика)
- Автогенерация:
  - `--thesis-autogen-batch 2|3` — размер пакета (по умолчанию 3)
  - `--thesis-autogen-disable` — выключить автогенерацию

## Примеры

Строже к шумам:
```bash
uv run python main.py live --vad-aggr 3 --min-consec 8 --flatness-th 0.50 --asr --llm
```

Мягче к шумам:
```bash
uv run python main.py live --vad-aggr 2 --min-consec 5 --flatness-th 0.65 --asr --llm
```

Только статические тезисы:
```bash
# Заполните diarization/theses.txt построчно
uv run python main.py live --asr --llm --theses theses.txt --thesis-autogen-disable
```

## Архитектура (файлы)

- `main.py` — CLI: `enroll`, `live`, интерактивный выбор профиля
- `live_recognizer.py` — основной цикл: VAD, сегментация, «свой/чужой», ASR/LLM/TTS, тезисы
- `asr_transcriber.py` — ASR (faster-whisper) + промпт/фильтры
- `llm_answer.py` — короткие ответы LLM
- `tts_silero.py` — озвучка ответов LLM
- `thesis_generator.py` — генерация тезисов (Gemini Flash Lite)
- `thesis_judge.py` — судья «тезис покрыт» (Gemini)
- `thesis_prompter.py` — логика помощника: ключевые слова/семантика/Gemini
- `ws_server.py` — гибридный сервер: WebSocket (PCM вход, WAV выход) + HTTP статика (`index.html`, `index.js`, `index.css`)

## Частые вопросы

- Нет `GEMINI_API_KEY` — генерация/судья отключатся автоматически; останутся токены/семантика.
- Ошибки CUDA при ASR — автоматически фоллбэк на CPU; можно явно `--asr-device cpu`.
- Микрофон не 16 kHz — напишите, добавим ресэмплинг.

## Лицензии

Проверьте лицензии используемых моделей (Hugging Face, Google AI Studio) и соблюдайте их условия.

